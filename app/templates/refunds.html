
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>GoSlow - Bootstrap 4 Alpha</title>

    <!-- Bootstrap core CSS -->
    {% assets "common_css" %}
      <link href="{{ ASSET_URL }}" rel="stylesheet">
    {% endassets %}

    <style type="text/css">
      body {
        padding-top: 20px;
        padding-bottom: 20px;
      }

      .navbar {
        margin-bottom: 20px;
      }
    </style>
  </head>

  <body>

    <div class="container">
      <nav class="navbar navbar-light bg-faded">
        <button class="navbar-toggler hidden-sm-up" type="button" data-toggle="collapse" data-target="#navbar-header" aria-controls="navbar-header">
          &#9776;
        </button>
        <div class="collapse navbar-toggleable-xs" id="navbar-header">
          <a class="navbar-brand" href="#">GoSlow</a>
          <ul class="nav navbar-nav">
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Features</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Pricing</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">About</a>
            </li>
          </ul>
          <form class="form-inline pull-xs-right">
            <input class="form-control" type="text" placeholder="Search">
            <button class="btn btn-success-outline" type="submit">Search</button>
          </form>
        </div>
      </nav> <!-- /navbar -->
      <h1>Refund</h1>
      <div class="jumbotron">
        <form>
          <fieldset class="form-group">
            <label for="email">PRESTO Card Number</label>
            <input name="pc_number" type="text" class="form-control" id="prestocard_number" placeholder="Enter PRESTO Card Number">
            <div class="checkbox">
              <label>
                 <small><input type="checkbox"> Save for future refunds</small>
              </label>
            </div>
          </fieldset>
          <fieldset class="form-group">
            <label for="email">Email address</label>
            <input name="email" type="email" class="form-control" id="email" placeholder="Enter email">
            <div class="checkbox">
              <label>
                 <small><input type="checkbox"> Save for future refunds</small>
              </label>
            </div>
          </fieldset>
          <fieldset class="form-group">
            <label for="date">Date of Travel</label>
            <input name="travel_date" type="text" class="form-control" id="datepicker" placeholder="Date of Travel">
          </fieldset>
          
          <fieldset class="form-group">
            <label for="depart_station">Departing Station</label>
            <select name="from_station" class="form-control" id="depart_station">
              <option value="" disabled selected>Select your departing station</option>
              {% for s in stops %}
                <option value="{{s.stop_id}}">{{s.stop_name}}</option>
              {% endfor %}
            </select>
          </fieldset>
          <fieldset class="form-group">
            <label for="arrival_station">Arrival Station</label>
            <select name="to_station"class="form-control" id="arrival_station">
              
            </select>
          </fieldset>
          <fieldset class="form-group">
            <label for="depart_time">Time Departed</label>
            <select name="travel_time" class="form-control" id="depart_time">
              
            </select>
          </fieldset>

          <fieldset class="form-group">
            <small class="text-muted">We'll never share the information you enter with anyone else. We only keep refund data associated with date travelled, departing/arriving stations and departure time for reporting/analyzing Go Transit delays.</small>
          </fieldset>

          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
    </div> <!-- /container -->


        <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
    {% assets "common_js" %}
      <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}

    <script>
      $(document).ready(function(){
        var depart_station, arrival_station, depart_time, travel_dow, travel_date;

        $('#prestocard_number').mask('0000 0000 0000 00000');

        var picker = new Pikaday({
          field: document.getElementById('datepicker'),
          minDate: moment().subtract(7, 'days').toDate(),
          maxDate: moment().toDate(),
          onSelect: function(){
            travel_dow = moment(this.getDate()).day();
            travel_date = moment(this.getDate()).date()
          }
        });

        picker.setDate(moment().toDate());

        $('form').on('change', '#depart_station',function(){
          $('#arrival_station, #depart_time').empty();
          var $this = $(this);
          if($(this).val() != ""){
            $.get('/api/go/stops/' + $(this).val(), function(r){
              $.each(r.routes, function(i, e){
                if(e.stop_id != $this.val()){
                  $('#arrival_station').append('<option value="' + e.stop_id + '">' + e.stop_name + '</option>');
                }
              });

              $('#arrival_station').change();
            });

            depart_station = $this.val();
          }
        });

        $('form').on('change', '#arrival_station', function(){
          var $this = $(this);
          arrival_station = $this.val();
          $.get('/api/go/search/' + depart_station + '/' + arrival_station + '/' + travel_dow, function(r){
            $('#depart_time').empty();
            $.each(r.trips, function(i, e){
              $('#depart_time').append('<option value="' + e.trip_id + '">' + e.departure_time.slice(0,-3) + '</option>');
            });
          });
        });

        $('form').on('submit', function(e){
          var $this = $(this);
          e.preventDefault();

          var deptime = $('#depart_time').val().split('-')[2].indexOf('x') == -1 ? $('#depart_time').val().split('-')[2] : $('#depart_time').val().split('-')[2].replace(/([A-Za-z])\w+/g,'');
          
          $.ajax({
            url: '/api/go/refund',
            method: 'POST',
            data: {
              'pc_number': $('#prestocard_number').val().replace(/\s+/g, ''),
              'email': $('#email').val(),
              'travel_date': travel_date,
              'from_station': $('#depart_station').val(),
              'to_station': $('#arrival_station').val(),
              'travel_time': deptime
            },
            success: function(r){
              console.log(r);
            }
          });
        });
      });
    </script>
  </body>
</html>
